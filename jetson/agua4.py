#!/usr/bin/python
from OSC import OSCServer, OSCClient, OSCMessage, ThreadingOSCServer
import sys
from time import sleep
import serial
import array
import time
import math
import subprocess
import threading

global colorNew
global ondasNew
global sumasNew
global spotRGBNew
global arduino

global color
color = [[0 for x in range(3)] for y in range(33)]

global ondas
ondas = [[0 for x in range(5)] for y in range(33)]
global sumas
sumas = [[0 for x in range(6)] for y in range(33)]
global spot
spot = [[0 for x in range(4)] for y in range(33)]


#!----------------PRESETS----------------------
color[0]=[[0,0,254], [0,0,254], [0,0,254], [0,0,254], [0,0,254], [0,0,254]]
ondas[0]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[0]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[0]=[0,30,150,80]

color[1]=[[17,254,235], [17,254,235], [17,254,235], [17,254,235], [17,254,235], [17,254,235]]
ondas[1]=[[0,1.0,0.1,0.5,0], [0,1.0,0.1,0,0], [0,1.0,0.1,0,0], [0,1.0,0.1,0,0], [0,1.0,0.1,0,0], [0,1.0,0.1,0,0]]
sumas[1]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[1]=[0,100,200,50]

color[3]=[[0,250,0], [0,250,0], [0,250,0], [0,250,0], [0,250,0], [0,250,0]]
ondas[3]=[[0,1.0,0.1,0.0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[3]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[3]=[0,170,0,70]

color[4]=[[250,120,0], [250,120,0], [250,120,0], [250,120,0], [250,120,0], [250,120,0]]
ondas[4]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[4]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[4]=[200,170,0,0]

color[6]=[[250,230,0], [250,230,0], [250,230,0], [250,230,0], [250,230,0], [250,230,0]]
ondas[6]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[6]=[[1,0.0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[6]=[170,90,0,0]

color[7]=[[250,0,0], [250,0,0], [250,0,0], [250,0,0], [250,0,0], [250,0,0]]
ondas[7]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[7]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[7]=[200,130,130,50]

color[9]=[[250,0,250], [250,0,250], [250,0,250], [250,0,250], [250,0,250], [250,0,250]]
ondas[9]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.6,0], [0,1.0,0.1,0.8,0], [0,1.0,0.1,0.6,0]]
sumas[9]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[9]=[200,150,200,100]

color[10]=[[115,0,250], [115,0,250], [115,0,250], [115,0,250], [115,0,250], [115,0,250]]
ondas[10]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0,0], [0,1.0,0.15,0,0], [0,1.0,0.15,0,0], [0,1.0,0.15,0,0], [0,1.0,0.15,0,0]]
sumas[10]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[10]=[100,80,120,0]

color[2]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[2]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[2]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[2]=[0,0,200,0]

color[5]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[5]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[5]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[5]=[0,170,140,0]

color[8]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[8]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[8]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[8]=[0,200,0,0]

color[11]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[11]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[11]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[11]=[170,40,0,0]

color[12]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[12]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[12]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[12]=[170,0,170,0]

color[13]=[[230,230,0], [230,200,0], [230,160,0], [230,100,0], [230,40,0], [250,0,0]]
ondas[13]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[13]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[13]=[50,50,50,100]

color[14]=[[0,230,70], [0,220,130], [0,230,170], [0,230,220], [0,150,230], [0,70,230]]
ondas[14]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[14]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[14]=[50,50,50,100]

color[15]=[[220,30,0], [220,130,0], [200,200,0], [20,220,0], [0,220,170], [0,190,220]]
ondas[15]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[15]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[15]=[50,50,50,100]

color[16]=[[230,230,0], [230,200,0], [230,160,0], [230,100,0], [230,40,0], [250,0,0]]
ondas[16]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[16]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[16]=[0,0,230,0]

color[17]=[[230,230,0], [230,200,0], [230,160,0], [230,100,0], [230,40,0], [250,0,0]]
ondas[17]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[17]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[17]=[230,0,190,0]


color[18]=[[0,0,254], [0,0,254], [0,0,254], [0,0,254], [0,0,254], [0,0,254]]
ondas[18]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[18]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[18]=[0,30,150,80]

color[19]=[[17,254,235], [17,254,235], [17,254,235], [17,254,235], [17,254,235], [17,254,235]]
ondas[19]=[[0,1.0,0.1,0.5,0], [0,1.0,0.1,0,0], [0,1.0,0.1,0,0], [0,1.0,0.1,0,0], [0,1.0,0.1,0,0], [0,1.0,0.1,0,0]]
sumas[19]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[19]=[0,100,200,50]

color[21]=[[0,250,0], [0,250,0], [0,250,0], [0,250,0], [0,250,0], [0,250,0]]
ondas[21]=[[0,1.0,0.1,0.0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[21]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[21]=[0,170,0,70]

color[22]=[[250,120,0], [250,120,0], [250,120,0], [250,120,0], [250,120,0], [250,120,0]]
ondas[22]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[22]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[22]=[200,170,0,0]

color[24]=[[250,230,0], [250,230,0], [250,230,0], [250,230,0], [250,230,0], [250,230,0]]
ondas[24]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[24]=[[1,0.0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[24]=[170,90,0,0]

color[25]=[[250,0,0], [250,0,0], [250,0,0], [250,0,0], [250,0,0], [250,0,0]]
ondas[25]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[25]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[25]=[200,130,130,50]

color[27]=[[250,0,250], [250,0,250], [250,0,250], [250,0,250], [250,0,250], [250,0,250]]
ondas[27]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.6,0], [0,1.0,0.1,0.8,0], [0,1.0,0.1,0.6,0]]
sumas[27]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[27]=[200,150,200,100]

color[28]=[[115,0,250], [115,0,250], [115,0,250], [115,0,250], [115,0,250], [115,0,250]]
ondas[28]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0,0], [0,1.0,0.15,0,0], [0,1.0,0.15,0,0], [0,1.0,0.15,0,0], [0,1.0,0.15,0,0]]
sumas[28]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[28]=[100,80,120,0]

color[20]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[20]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[20]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[20]=[0,0,200,0]

color[23]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[23]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[23]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[23]=[0,170,140,0]

color[26]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[26]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[26]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[26]=[0,200,0,0]

color[29]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[29]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[29]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[29]=[170,40,0,0]

color[30]=[[250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250], [250,250,250]]
ondas[30]=[[0,1.0,0.15,0,0], [0,1.0,0.15,0.1,0], [0,1.0,0.15,0.2,0], [0,1.0,0.15,0.3,0], [0,1.0,0.15,0.4,0], [0,1.0,0.15,0.5,0]]
sumas[30]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[30]=[170,0,170,0]

color[31]=[[230,230,0], [230,200,0], [230,160,0], [230,100,0], [230,40,0], [250,0,0]]
ondas[31]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[31]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[31]=[50,50,50,100]

color[32]=[[0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0]]
ondas[32]=[[0,1.0,0.1,0,0], [0,1.0,0.1,0.1,0], [0,1.0,0.1,0.2,0], [0,1.0,0.1,0.3,0], [0,1.0,0.1,0.4,0], [0,1.0,0.1,0.5,0]]
sumas[32]=[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]
spot[32]=[50,50,50,100]
#!----------------SERIAL_PORT----------------------
global ser
def open_serial():
    global ser
    ser = serial.Serial(
        port="/dev/charly",
        baudrate=750000,
        parity=serial.PARITY_NONE,
        stopbits=serial.STOPBITS_ONE,
        bytesize=serial.EIGHTBITS
    )
    print("USB connected")

#!----------------ARDUINO_PORT----------------------
p=subprocess.Popen('ls -la /dev |grep ACM | awk \'{print $10}\' FS=" " > tmp2', shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
time.sleep(1)
arduino = serial.Serial(
    port="/dev/"+str(open('tmp2','r').read())[:-1],
    baudrate=9600
    )
print("arduino connected")
  
      #!----------------OSC_HANDLERS----------------------
def handler_test(path, tags, args, source):
    global estado
    client.send( OSCMessage("/test", [args[0]] ) )
    estado=1
    fuentes_up()
    print("test")

def handler_preset(path, tags, args, source):
    set_preset(args[0])
    print("scene")
    arduino.write(str(spotRGBNew))
    client.send( OSCMessage("/preset", [args[0]] ) )

def handler_shutDown(path, tags, args, source):
    global estado
    fuentes_down()
    client.send( OSCMessage("/shutdown", [0] ) )
    estado=0
    set_preset(28)
    arduino.write('1c0w2c0w3c0w4c0w')
    print("shutDown") 
    subprocess.Popen('./stop.sh', shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)

def handler_spots(path, tags, args, source):
    global spotRGBNew
    client.send( OSCMessage("/spots", [args[0]] ) )
    if(args[0]==0):
        arduino.write('1c0w2c0w3c0w4c0w')
        print("spot = 1c0w2c0w3c0w4c0w")
    else:
        arduino.write(str(spotRGBNew))
        print("spot = " + str(spotRGBNew))


receive_address = '192.168.15.22', 9001
server = ThreadingOSCServer(receive_address) 
server.addDefaultHandlers()
server.addMsgHandler( "/test", handler_test )
server.addMsgHandler( "/preset", handler_preset )
server.addMsgHandler( "/shutdown", handler_shutDown )
server.addMsgHandler( "/spots", handler_spots )
for addr in server.getOSCAddressSpace():
	print addr
server.timeout = 0
st=threading.Thread(target=server.serve_forever)
st.start()

client = OSCClient()
client.connect( ("192.168.15.238", 2345) )

#!----------------FUNCTIONS----------------------
def invertedRange(start,end,step):
    while start > end:
        yield start
        start -= step

def setup():
    global lista
    for a in range(0,LONGITUD*6):
        lista.append(0)
        lista.append(0)
        lista.append(0)
    ser.flushInput()
    ser.flushOutput()
    lista.append(255)
    arr = bytearray(lista)
    del lista[len(lista)-1]
    ser.write(arr)
    print("sending message : ImOn")
    client.send( OSCMessage("/imOn") )

def set_preset(new_preset):
    global colorNew
    global ondasNew
    global sumasNew
    global spotRGBNew
    global color
    global ondas
    global sumas
    global spot
    fuentes_up()
    print("changing to new preset " + str(new_preset))
    if(new_preset>=0 and new_preset<=32):
        colorNew=color[new_preset]
        ondasNew=ondas[new_preset]
        sumasNew=sumas[new_preset]
 
        spotRGBNew= ("1c" + str(spot[new_preset][0]) + "w" + "2c" + str(spot[new_preset][1]) + "w" + "3c" + str(spot[new_preset][2]) + "w" + "4c" + str(spot[new_preset][3]) + "w")
        # spotRGBNew=str(spot0[0])+" "+str(spot0[1])+" "+str(spot0[2])+" "+str(spot0[3])
    else:
        print("preset error");

def calculaOnda(cual_onda):
    global ondasNew
    elapsed_time = time.time() - start_time
    amp=ondasNew[cual_onda][1]
    freq=ondasNew[cual_onda][2]
    fase=ondasNew[cual_onda][3]
    rev=ondasNew[cual_onda][4]
    if(ondasNew[cual_onda][0]==0 or ondasNew[cual_onda][0]==1):
        return amp*(math.sin(2*math.pi*freq*elapsed_time+fase)+1)/2.0
    elif(ondasNew[cual_onda][0]==2):
        return (math.copysign(1,math.sin(2*math.pi*freq*elapsed_time+fase))+1)/2.0
    elif(ondasNew[cual_onda][0]==3):
        return amp*math.atan((math.cos(2*math.pi*freq*elapsed_time+fase)/math.sin(2*math.pi*freq*elapsed_time+fase)+1)/2.0)

def getIndice(cual_indice):
    global sumasNew

    indice=0
    cont=0
    for x in sumasNew[cual_indice]:
        if(x>0):
            indice=indice+(x*calculaOnda(cont))
        cont=cont+1
    return indice

def addLista(cual,old_lista):
    global ondasNew
    global colorNew

    newLista=old_lista[:]
    elapsed_time=time.time()-start_time
    indice=getIndice(cual)
    if(ondasNew[cual][0]==0):
        for i in range(LONGITUD*cual,LONGITUD*(cual+1)):
            newLista[(i)*3+2]=int(indice * colorNew[cual][2])
            newLista[(i)*3+1]=int(indice * colorNew[cual][0])
            newLista[(i)*3]=int(indice * colorNew[cual][1])
    else:
        newLista[LONGITUD*cual*3+0] = int(indice * colorNew[cual][1])
        newLista[LONGITUD*cual*3+1] = int(indice * colorNew[cual][0])
        newLista[LONGITUD*cual*3+2] = int(indice * colorNew[cual][2])
        for i in invertedRange((cual+1)*LONGITUD-1,cual*LONGITUD,1):
            newLista[(i)*3+2]=lista[(i-1)*3+2]
            newLista[(i)*3+1]=lista[(i-1)*3+1]
            newLista[(i)*3]=lista[(i-1)*3]
    return newLista

def update():
    global lista
    for x in xrange(0,6):
        newLista=addLista(x,lista)
        lista=newLista
    newLista.append(255)
    ser.flushInput()
    ser.flushOutput()
    #print(newLista[0])
    arr = bytearray(newLista)
    del newLista[len(newLista)-1]
    newLista = []
    ser.write(arr)

def fuentes_up():
    arduino.write('5c255w')

def fuentes_down():
    arduino.write('5c0w')



    #!----------------GLOBALES----------------------
global preset
preset=1
global lista
lista=[]
global conta
conta=0
global colorNew
global ondasNew
global sumasNew
global estado
global spotRGBNew
spotRGBNew="0 0 0 0"
estado=0

start_time = time.time()
LONGITUD=204
#!----------------main----------------------

try :
	open_serial()
	setup()
	set_preset(32)	
	while True:
		update()

except KeyboardInterrupt:
    arduino.close()
    ser.close()
    server.close()
    st.join()
